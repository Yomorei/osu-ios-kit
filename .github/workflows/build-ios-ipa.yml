name: Build unsigned iOS IPA

on:
  workflow_dispatch:
    inputs:
      osu_repo:
        description: "Repo to build (owner/name)"
        required: true
        default: "Yomorei/osu-ios"
      osu_ref:
        description: "Branch/tag/commit to build"
        required: true
        default: "kit/private-servers-ui"

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout kit repo
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Checkout osu repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.osu_repo }}
          ref: ${{ inputs.osu_ref }}
          path: upstream
          fetch-depth: 0

      - name: Show build target
        shell: bash
        run: |
          echo "repo=${{ inputs.osu_repo }}"
          echo "ref=${{ inputs.osu_ref }}"
          git -C upstream rev-parse HEAD
          git -C upstream log -1 --oneline
          git -C upstream remote -v

      - name: Install workloads required by project
        shell: bash
        run: |
          cd upstream
          dotnet workload restore

      - name: Build unsigned IPA
        shell: bash
        run: |
          cd upstream
          dotnet publish osu.iOS/osu.iOS.csproj \
            -c Release -f net8.0-ios -r ios-arm64 \
            -p:BuildIpa=true \
            -p:MtouchLink=SdkOnly \
            -p:EnableCodeSigning=false

      - name: Collect IPA
        shell: bash
        run: |
          rm -rf out
          mkdir -p out
          find upstream -maxdepth 10 -name "*.ipa" -print -exec cp "{}" out/osu-ios.ipa \;
          test -f out/osu-ios.ipa

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: osu-ios-ipa
          path: out/osu-ios.ipa
