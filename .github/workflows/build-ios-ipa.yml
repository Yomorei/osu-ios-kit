name: Build unsigned iOS IPA

on:
  workflow_dispatch:
    inputs:
      osu_ref:
        description: "ppy/osu ref (branch, tag, or commit)"
        required: false
        default: "master"

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout kit repo
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Clone upstream osu
        run: |
          git clone https://github.com/ppy/osu.git upstream
          cd upstream
          git fetch --tags --force
          git checkout "${{ inputs.osu_ref }}"

      - name: Apply patches
        run: |
          cd upstream
          if ls ../patches/*.patch >/dev/null 2>&1; then
            git apply --3way ../patches/*.patch
          else
            echo "No patches found in ../patches"
            exit 1
          fi

      - name: Install iOS workload
        working-directory: upstream
        run: |
          dotnet workload restore
          dotnet workload install ios

      - name: Restore
        working-directory: upstream
        run: dotnet restore osu.iOS/osu.iOS.csproj

      - name: Build unsigned IPA
        working-directory: upstream
        run: dotnet publish osu.iOS/osu.iOS.csproj -c Release -f net8.0-ios -r ios-arm64 -p:BuildIpa=true -p:MtouchLink=SdkOnly -p:EnableCodeSigning=false

      - name: Collect IPA
        run: |
          mkdir -p out
          IPA_PATH="$(find upstream -type f -name "*.ipa" | head -n 1)"
          if [ -z "$IPA_PATH" ]; then
            echo "No IPA produced."
            ls -la upstream/osu.iOS/bin || true
            exit 1
          fi
          cp "$IPA_PATH" out/osu-ios.ipa
          ls -la out/osu-ios.ipa

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: osu-ios-ipa
          path: out/osu-ios.ipa
