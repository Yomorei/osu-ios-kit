From bb02569760abb33e68bbe679bb39957ef8076081 Mon Sep 17 00:00:00 2001
From: Yomorei <Yomoreibusiness@gmail.com>
Date: Tue, 3 Feb 2026 12:21:27 -0600
Subject: [PATCH 05/10] ci: added ios-ipa workflow

---
 .github/workflows/ios-ipa.yml | 98 +++++++++++++++++++++++++++++++++++
 1 file changed, 98 insertions(+)
 create mode 100644 .github/workflows/ios-ipa.yml

diff --git a/.github/workflows/ios-ipa.yml b/.github/workflows/ios-ipa.yml
new file mode 100644
index 0000000000..79309f0ac6
--- /dev/null
+++ b/.github/workflows/ios-ipa.yml
@@ -0,0 +1,98 @@
+name: iOS IPA (manual)
+
+on:
+  workflow_dispatch:
+    inputs:
+      configuration:
+        type: choice
+        description: Build configuration
+        options: [Debug, Release]
+        default: Debug
+      signing:
+        type: choice
+        description: IPA signing mode
+        options: [unsigned, signed]
+        default: unsigned
+
+jobs:
+  build:
+    runs-on: macos-15
+    timeout-minutes: 60
+
+    steps:
+      - uses: actions/checkout@v4
+
+      - uses: actions/setup-dotnet@v4
+        with:
+          dotnet-version: "8.0.x"
+
+      - name: Install iOS workload
+        run: dotnet workload install ios
+
+      # This is only needed if you choose "signed" and you have secrets set..
+      - name: Import signing assets (signed mode)
+        if: ${{ inputs.signing == 'signed' }}
+        shell: bash
+        env:
+          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
+          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
+          IOS_MOBILEPROVISION_BASE64: ${{ secrets.IOS_MOBILEPROVISION_BASE64 }}
+        run: |
+          set -euo pipefail
+
+          if [ -z "${IOS_P12_BASE64:-}" ] || [ -z "${IOS_P12_PASSWORD:-}" ] || [ -z "${IOS_MOBILEPROVISION_BASE64:-}" ]; then
+            echo "Missing signing secrets. Set IOS_P12_BASE64, IOS_P12_PASSWORD, IOS_MOBILEPROVISION_BASE64."
+            exit 1
+          fi
+
+          echo "$IOS_P12_BASE64" | base64 --decode > signing.p12
+          echo "$IOS_MOBILEPROVISION_BASE64" | base64 --decode > profile.mobileprovision
+
+          security create-keychain -p "" build.keychain
+          security set-keychain-settings -lut 21600 build.keychain
+          security unlock-keychain -p "" build.keychain
+          security import signing.p12 -k build.keychain -P "$IOS_P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
+          security list-keychains -d user -s build.keychain
+
+          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
+          UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< "$(security cms -D -i profile.mobileprovision)")
+          cp profile.mobileprovision "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"
+
+      - name: Publish IPA
+        shell: bash
+        run: |
+          set -euo pipefail
+          CFG="${{ inputs.configuration }}"
+          SIGN="${{ inputs.signing }}"
+
+          if [ "$SIGN" = "unsigned" ]; then
+            dotnet publish osu.iOS/osu.iOS.csproj \
+              -c "$CFG" -f net8.0-ios -r ios-arm64 \
+              -p:BuildIpa=true \
+              -p:EnableCodeSigning=false \
+              -p:CodesignRequireProvisioningProfile=false \
+              -p:EnableDefaultCodesignEntitlements=false
+          else
+            dotnet publish osu.iOS/osu.iOS.csproj \
+              -c "$CFG" -f net8.0-ios -r ios-arm64 \
+              -p:BuildIpa=true
+          fi
+
+      - name: Collect IPA
+        shell: bash
+        run: |
+          set -euo pipefail
+          IPA="$(find . -type f -name '*.ipa' | head -n 1 || true)"
+          if [ -z "$IPA" ]; then
+            echo "No .ipa produced. Dumping likely output dirs:"
+            find . -maxdepth 6 -type d -name "publish" -print || true
+            exit 1
+          fi
+          echo "IPA=$IPA"
+          cp "$IPA" osu-ios.ipa
+
+      - name: Upload artifact
+        uses: actions/upload-artifact@v4
+        with:
+          name: osu-ios-ipa
+          path: osu-ios.ipa
-- 
2.50.1.windows.1

